"use strict";(self.webpackChunkwixweb=self.webpackChunkwixweb||[]).push([[65017],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),m=a,g=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return n?r.createElement(g,o(o({ref:t},c),{},{components:n})):r.createElement(g,o({ref:t},c))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:a,o[1]=s;for(var p=2;p<i;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},91761:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>g,frontMatter:()=>s,metadata:()=>p,toc:()=>u});n(67294);var r=n(3905);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}const s={wip:4632,type:"Feature",by:"Heath Stewart (heaths@microsoft.com)",title:"Use ETW for Logging"},l=void 0,p={unversionedId:"development/wips/use-etw-for-logging",id:"development/wips/use-etw-for-logging",title:"Use ETW for Logging",description:"User stories",source:"@site/docs/development/wips/4632-use-etw-for-logging.md",sourceDirName:"development/wips",slug:"/development/wips/use-etw-for-logging",permalink:"/wixtoolset/docs/development/wips/use-etw-for-logging",draft:!1,editUrl:"https://github.com/wixtoolset/web/tree/master/src/Docusaurus/docs/development/wips/4632-use-etw-for-logging.md",tags:[],version:"current",sidebarPosition:4632,frontMatter:{wip:4632,type:"Feature",by:"Heath Stewart (heaths@microsoft.com)",title:"Use ETW for Logging"},sidebar:"docsSidebar",previous:{title:"Migrate v3 Source Code to v4.",permalink:"/wixtoolset/docs/development/wips/migrate-v3-source-code-to-v4"},next:{title:"Builtin thmutil Button Functionality",permalink:"/wixtoolset/docs/development/wips/builtin-thmutil-button-functionality"}},c={},u=[{value:"User stories",id:"user-stories",level:2},{value:"Current design",id:"current-design",level:2},{value:"Proposal",id:"proposal",level:2},{value:"Considerations",id:"considerations",level:2},{value:"See also",id:"see-also",level:2}],d={toc:u},m="wrapper";function g(e){var{components:t}=e,n=o(e,["components"]);return(0,r.kt)(m,i(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){a(e,t,n[t])}))}return e}({},d,n),{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"user-stories"},"User stories"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"As a developer I can use the existing Trace and Exit macros to write events to a trace listener."),(0,r.kt)("li",{parentName:"ul"},"As a developer I can conditionally write computationally expensive events to a trace listener."),(0,r.kt)("li",{parentName:"ul"},"As a developer I can write events to a trace listener without having to link additional string resources."),(0,r.kt)("li",{parentName:"ul"},"As an administrator I can enable and view additional logging details on the local or remote machines."),(0,r.kt)("li",{parentName:"ul"},"As an administrator I can trigger actions on certain events.")),(0,r.kt)("h2",{id:"current-design"},"Current design"),(0,r.kt)("p",null,"Our current design is pretty straight forward but relies on compile-time overrides for logging targets. This means that any Trace or Exit macros used in libraries like ",(0,r.kt)("em",{parentName:"p"},"dutil.lib")," cannot be redirected to, say, a log file created and written to by burn. Additionally, some logging we have avoided because of the size added by string resources and additional computation required by functions like ",(0,r.kt)("inlineCode",{parentName:"p"},"PlanDump")," in ",(0,r.kt)("em",{parentName:"p"},"engine.lib")," only when ",(0,r.kt)("inlineCode",{parentName:"p"},"#DEBUG")," is defined. These log events are often useful for debugging issues with release binaries in the field."),(0,r.kt)("p",null,"The existing macros as of v3.10 are now variadic, which means they can take any number of arguments without using different macro definitions. This can also make it easy to shoe-horn different functions to call and still use the existing macros that are in heavy use throughout the code."),(0,r.kt)("h2",{id:"proposal"},"Proposal"),(0,r.kt)("p",null,"ETW provides a powerful facility for logging event data that different listeners - including the running executable itself, such as ",(0,r.kt)("em",{parentName:"p"},"burn.exe")," - can choose to write to a log file or any other output."),(0,r.kt)("p",null,"We can create an ",(0,r.kt)("a",{parentName:"p",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/aa364098(v=vs.85).aspx"},"event provider")," for each library such as ",(0,r.kt)("em",{parentName:"p"},"dutil.lib")," and ",(0,r.kt)("em",{parentName:"p"},"engine.lib")," that can be enabled and disabled by administrators as needed, while ",(0,r.kt)("em",{parentName:"p"},"burn.exe")," maintains the ability to enable them in-proc and write all events to the burn log. An additional provider (because, it seems, a manifest and its resources cannot be split across providers) can be created for more advanced logging like ",(0,r.kt)("inlineCode",{parentName:"p"},"PlanDump"),", which ",(0,r.kt)("em",{parentName:"p"},"engine.lib")," can calculate conditionally if the provider is enabled using ",(0,r.kt)("inlineCode",{parentName:"p"},"EventProviderEnabled"),". The need for this may not be necessary, however, since ETW manifests can contain mappings for enumerations that automatically log the string resource for the passed enumeration value."),(0,r.kt)("p",null,"Managed code can also use these facilities through the ",(0,r.kt)("a",{parentName:"p",href:"http://msdn.microsoft.com/en-us/library/system.diagnostics.tracing(v=vs.110).aspx"},"APIs")," provided in .NET or the more powerful ",(0,r.kt)("a",{parentName:"p",href:"https://www.nuget.org/packages/Microsoft.Diagnostics.Tracing.EventSource"},"Microsoft.Diagnostics.Tracing.EventSource")," NuGet package that enables writing to the Windows Event log by default."),(0,r.kt)("p",null,"Since we have a great number of string resources already and because ETW appears to support referencing string resources by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"mc")," prefix like in the following example, we can actually keep the ",(0,r.kt)("em",{parentName:"p"},"*",".mc")," files we currently compile and link and even add to them later. The major difference will be that toolset developers will have to add an entry to the event manifest as well as the ",(0,r.kt)("em",{parentName:"p"},"*",".mc")," file, or use the ",(0,r.kt)("inlineCode",{parentName:"p"},"string")," prefix instead and define them in the manifest (which, when compiled by ",(0,r.kt)("em",{parentName:"p"},"mc.exe"),", will output a resource DLL anyway)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'\x3c!-- reference a string resource defined in a resource DLL already --\x3e\n<provider name="$(mc.ProviderName)" .../>\n\n\x3c!-- reference a string resource defined in the manifest --\x3e\n<provider name="$(string.ProviderName)" .../>\n')),(0,r.kt)("p",null,"For more information, see ",(0,r.kt)("a",{parentName:"p",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/dd996927(v=vs.85).aspx"},"localizing message strings"),"."),(0,r.kt)("h2",{id:"considerations"},"Considerations"),(0,r.kt)("p",null,"The existing Exit and Trace functions - along with the Log functions - should be updated to call ",(0,r.kt)("inlineCode",{parentName:"p"},"EventWrite")," and related functions passing in the variadic ",(0,r.kt)("inlineCode",{parentName:"p"},"__VA_ARGS__"),", though in this case you'll lose IntelliSense help for variable names and types. We could update the build system to generate the headers required for developers to call the specific functions if we care to."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"mc")," localized string resource prefix is also not well-documented, though references to it exist in MSDN. So we should be okay to use it, though some additional prototyping may be necessary to accurately discover whether resources must be embedded or separate."),(0,r.kt)("p",null,"Most importantly, though, is that ETW is only supported in Windows Vista and newer. Windows XP - which WiX v3 still supports - only supports the older ",(0,r.kt)("a",{parentName:"p",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/aa363652(v=vs.85).aspx"},"event logging")," APIs which were rebuilt on top of ETW starting with Windows Vista. If we choose to support Windows XP with WiX v4 we can either,"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use only ",(0,r.kt)("a",{parentName:"li",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/aa363652(v=vs.85).aspx"},"event logging")," APIs, or"),(0,r.kt)("li",{parentName:"ul"},"Conditionally use ",(0,r.kt)("a",{parentName:"li",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/bb968803(v=vs.85).aspx"},"event tracing")," APIs if on Vista")),(0,r.kt)("p",null,"The drawbacks to using the ",(0,r.kt)("a",{parentName:"p",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/aa363652(v=vs.85).aspx"},"event logging")," APIs are a limited feature set, the need to write WMI manifests (",(0,r.kt)("em",{parentName:"p"},"*",".mof")," files), and the lack of conditional logging."),(0,r.kt)("p",null,"For example, MSDN documentation purports that mappings are not supported by the ",(0,r.kt)("a",{parentName:"p",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/aa363652(v=vs.85).aspx"},"event logging")," APIs, though some prototyping has shown that ",(0,r.kt)("em",{parentName:"p"},"mc.exe")," does mostly generate ",(0,r.kt)("em",{parentName:"p"},"*",".mof")," files with WMI attributes to support mappings - the only thing missing is the friendly string names (which would require further post-processing). The enumeration values are attributed to the corresponding symbols."),(0,r.kt)("h2",{id:"see-also"},"See also"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://wixtoolset.org/issues/4632/"},"WIXFEAT:4632")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/bb968803(v=vs.85).aspx"},"Event tracing")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/aa364098(v=vs.85).aspx"},"Providing events")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/dd996927(v=vs.85).aspx"},"Localizing message strings")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://msdn.microsoft.com/en-us/library/system.diagnostics.tracing(v=vs.110).aspx"},"System.Diagnostics.Tracing")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.nuget.org/packages/Microsoft.Diagnostics.Tracing.EventSource"},"Microsoft.Diagnostics.Tracing.EventSource")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://msdn.microsoft.com/en-us/library/windows/desktop/aa363652(v=vs.85).aspx"},"Event logging"))))}g.isMDXComponent=!0}}]);