"use strict";(self.webpackChunkwixweb=self.webpackChunkwixweb||[]).push([[94362],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),h=o,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||a;return n?r.createElement(m,i(i({ref:t},c),{},{components:n})):r.createElement(m,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<a;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},20007:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>l,metadata:()=>p,toc:()=>u});n(67294);var r=n(3905);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}const l={wip:3249,type:"Feature",by:"r.sean.hall at gmail dot com",title:"Allow BA to Run Elevated Async Process Through the Engine",draft:!1},s=void 0,p={unversionedId:"development/wips/allow-ba-to-run-elevated-aync-process-through-engine",id:"development/wips/allow-ba-to-run-elevated-aync-process-through-engine",title:"Allow BA to Run Elevated Async Process Through the Engine",description:"User stories",source:"@site/docs/development/wips/3249-allow-ba-to-run-elevated-aync-process-through-engine.md",sourceDirName:"development/wips",slug:"/development/wips/allow-ba-to-run-elevated-aync-process-through-engine",permalink:"/wixtoolset/docs/development/wips/allow-ba-to-run-elevated-aync-process-through-engine",draft:!1,editUrl:"https://github.com/wixtoolset/web/tree/master/src/Docusaurus/docs/development/wips/3249-allow-ba-to-run-elevated-aync-process-through-engine.md",tags:[],version:"current",sidebarPosition:3249,frontMatter:{wip:3249,type:"Feature",by:"r.sean.hall at gmail dot com",title:"Allow BA to Run Elevated Async Process Through the Engine",draft:!1},sidebar:"docsSidebar",previous:{title:"WIPs",permalink:"/wixtoolset/docs/category/wips"},next:{title:"thmutil variable support",permalink:"/wixtoolset/docs/development/wips/thmutil-variable-support"}},c={},u=[{value:"User stories",id:"user-stories",level:2},{value:"Security Context",id:"security-context",level:2},{value:"Proposal",id:"proposal",level:2},{value:"WixStandardBA",id:"wixstandardba",level:2},{value:"Considerations",id:"considerations",level:2},{value:"See Also",id:"see-also",level:2}],d={toc:u},h="wrapper";function m(e){var{components:t}=e,n=i(e,["components"]);return(0,r.kt)(h,a(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){o(e,t,n[t])}))}return e}({},d,n),{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"user-stories"},"User stories"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"As a setup developer I can create an elevated process asynchronously from a per-machine bundle without inflicting multiple UAC prompts on the user.")),(0,r.kt)("h2",{id:"security-context"},"Security Context"),(0,r.kt)("p",null,"There are currently two ways that the BA can execute arbitrary processes with elevation with only one UAC prompt."),(0,r.kt)("p",null,"One way is to hack the .exe manifest to require administrator.  Running the BA elevated is asking for trouble. There's nothing we can do to prevent this, beyond making the engine refuse to run in this scenario."),(0,r.kt)("p",null,"The second way is to put an EXE package in the chain that simply runs the executable specified in its command-line arguments.  We can't prevent this either without crippling EXE packages.  When you include an EXE package in the chain that will run anything you tell it, that means that compromising the BA gives an attacker the ability to run elevated code, which means game over."),(0,r.kt)("h2",{id:"proposal"},"Proposal"),(0,r.kt)("p",null,"Add the following method to ",(0,r.kt)("inlineCode",{parentName:"p"},"IBootstrapperEngine"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"STDMETHOD(LaunchApprovedExe)(\n    __in_opt HWND hwndParent,\n    __in_z LPCWSTR wzApprovedExeForElevationId,\n    __in_z_opt LPCWSTR wzArguments,\n    __in DWORD dwWaitForInputIdleTimeout\n    ) = 0;\n")),(0,r.kt)("p",null,"The engine will use the given Id to lookup the registry location specified at compile time, and then get the executable path from there.\nTo ensure that an unprivileged user can't modify the target executable, the path must be in a secure folder.\nFor now, the Package Cache folder and the Program Files folder(s) (x86 and x64) are the only folders considered secure.\nIf the file is not inside one of these folders, then the engine will return Access Denied.\nNormally the file would be an .exe that the bundle installed.\nThe engine will perform Variable substitution on wzArguments."),(0,r.kt)("p",null,"After verification, the engine will call ",(0,r.kt)("inlineCode",{parentName:"p"},"CreateProcess"),", attempting to set the working directory to the .exe's directory.\nIf dwWaitForInputIdleTimeout is not zero, the engine will call WaitForInputIdle with the given timeout.\nFinally, it will return the process id from the new ",(0,r.kt)("inlineCode",{parentName:"p"},"IBootstrapperApplication")," method:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// OnLaunchApprovedExeBegin - called before trying to launch the preapproved executable.\n//\nSTDMETHOD_(int, OnLaunchApprovedExeBegin)() = 0;\n\n// OnLaunchApprovedExeComplete - called after trying to launch the preapproved executable.\n//\n// Parameters:\n//  dwProcessId is only valid if the operation succeeded.\n//\nSTDMETHOD_(void, OnLaunchApprovedExeComplete)(\n    __in HRESULT hrStatus,\n    __in DWORD dwProcessId\n    ) = 0;\n")),(0,r.kt)("p",null,"In order to get an .exe approved to be run elevated, add a new element ",(0,r.kt)("inlineCode",{parentName:"p"},"ApprovedExeForElevation"),".  This element is a child of ",(0,r.kt)("inlineCode",{parentName:"p"},"Bundle"),", and can occur 0-unbounded times."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'<xs:element name="ApprovedExeForElevation">\n  <xs:annotation>\n    <xs:documentation>Provides a registry key path and value name that will point to an .exe so that the BA can request the engine to run it elevated.</xs:documentation>\n    <xs:appinfo>\n      <xse:parent namespace="http://schemas.microsoft.com/wix/2006/wi" ref="Bundle" />\n    </xs:appinfo>\n  </xs:annotation>\n  <xs:complexType>\n    <xs:attribute name="Id" type="xs:string" use="required">\n      <xs:annotation>\n        <xs:documentation>The identifier of the ApprovedExeForElevation element.</xs:documentation>\n      </xs:annotation>\n    </xs:attribute>\n    <xs:attribute name="Key" type="xs:string" use="required">\n      <xs:annotation>\n        <xs:documentation>\n          The key path.\n          For security purposes, the root key will be HKLM and Variables are not supported.\n        </xs:documentation>\n      </xs:annotation>\n    </xs:attribute>\n    <xs:attribute name="Value" type="xs:string">\n      <xs:annotation>\n        <xs:documentation>\n          The value name.\n          For security purposes, Variables are not supported.\n        </xs:documentation>\n      </xs:annotation>\n    </xs:attribute>\n    <xs:attribute name="Win64" type="YesNoTypeUnion">\n      <xs:annotation>\n        <xs:documentation>\n          Instructs the search to look in the 64-bit registry when the value is \'yes\'.\n          When the value is \'no\', the search looks in the 32-bit registry.\n          The default value is \'no\'.\n        </xs:documentation>\n      </xs:annotation>\n    </xs:attribute>\n  </xs:complexType>\n</xs:element>\n')),(0,r.kt)("h2",{id:"wixstandardba"},"WixStandardBA"),(0,r.kt)("p",null,"Add ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchTargetElevatedId")," attribute to ",(0,r.kt)("inlineCode",{parentName:"p"},"bal:WixStandardBootstrapperApplication")," element, which takes the ",(0,r.kt)("inlineCode",{parentName:"p"},"Id")," of an ",(0,r.kt)("inlineCode",{parentName:"p"},"ApprovedExeForElevation")," element.\nThis will make WixStandardBA use the new ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchApprovedExe")," method instead of ",(0,r.kt)("inlineCode",{parentName:"p"},"ShelExecute"),".\nIf ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchApprovedExe")," fails because of Access Denied, it will fallback to the previous behavior (calling ",(0,r.kt)("inlineCode",{parentName:"p"},"ShelExecute")," on the executable specified in the ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchTarget")," attribute)."),(0,r.kt)("p",null,"Add ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchArguments")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchHidden")," attributes to ",(0,r.kt)("inlineCode",{parentName:"p"},"bal:WixStandardBootstrapperApplication")," to give a documented way to use the magic variables ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchArguments")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchHidden"),"."),(0,r.kt)("h2",{id:"considerations"},"Considerations"),(0,r.kt)("p",null,"The original proposal added a second method to allow the BA to run an EXE package from the chain.  This was removed because packages are supposed to be included in the chain to participate in the installation, not launch executables after the installation completed."),(0,r.kt)("p",null,"The second version of the proposal made the setup developer provide the EXE at compile time so it could be hashed.\nThe engine allowed the BA to specify the executable path in ",(0,r.kt)("inlineCode",{parentName:"p"},"LaunchApprovedExe"),".\nThen the engine confirmed that the executable was in a secure folder as well as matching the hash.\nThis was changed to getting the executable path from HKLM to support the scenario where the target executable is patched outside of the bundle."),(0,r.kt)("h2",{id:"see-also"},"See Also"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://wixtoolset.org/issues/3249/"},"WIXFEAT:3249")))}m.isMDXComponent=!0}}]);