"use strict";(self.webpackChunkwixweb=self.webpackChunkwixweb||[]).push([[75077],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),u=a,h=c["".concat(s,".").concat(u)]||c[u]||m[u]||i;return n?o.createElement(h,r(r({ref:t},d),{},{components:n})):o.createElement(h,r({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,r=new Array(i);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:a,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},53495:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>h,frontMatter:()=>l,metadata:()=>p,toc:()=>c});n(67294);var o=n(3905);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function r(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}const l={wip:4773,type:"Feature",by:"Sean Hall (r sean hall at gmail.com)",title:"Modify Burn API",draft:!1},s=void 0,p={unversionedId:"development/wips/modify-burn-api",id:"development/wips/modify-burn-api",title:"Modify Burn API",description:"User stories",source:"@site/docs/development/wips/4773-modify-burn-api.md",sourceDirName:"development/wips",slug:"/development/wips/modify-burn-api",permalink:"/wixtoolset/docs/development/wips/modify-burn-api",draft:!1,editUrl:"https://github.com/wixtoolset/web/tree/master/src/Docusaurus/docs/development/wips/4773-modify-burn-api.md",tags:[],version:"current",sidebarPosition:4773,frontMatter:{wip:4773,type:"Feature",by:"Sean Hall (r sean hall at gmail.com)",title:"Modify Burn API",draft:!1},sidebar:"docsSidebar",previous:{title:"Add conditional command-line arguments to bundle packages",permalink:"/wixtoolset/docs/development/wips/add-conditional-command-line-arguments"},next:{title:"Don't Write ARP Entry",permalink:"/wixtoolset/docs/development/wips/dont-write-arp-entry"}},d={},c=[{value:"User stories",id:"user-stories",level:2},{value:"Background",id:"background",level:2},{value:"Proposal",id:"proposal",level:2},{value:"Native BA",id:"native-ba",level:2},{value:"WiX 3.x",id:"wix-3x",level:3},{value:"WiX 4.x",id:"wix-4x",level:3},{value:"Managed BA",id:"managed-ba",level:2},{value:"WiX 3.x",id:"wix-3x-1",level:3},{value:"WiX 4.x",id:"wix-4x-1",level:3},{value:".NET Framework",id:"net-framework",level:4},{value:".NET Core",id:"net-core",level:4},{value:"Both runtimes",id:"both-runtimes",level:4},{value:"Considerations",id:"considerations",level:2},{value:"See Also",id:"see-also",level:2}],m={toc:c},u="wrapper";function h(e){var{components:t}=e,n=r(e,["components"]);return(0,o.kt)(u,i(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),o.forEach((function(t){a(e,t,n[t])}))}return e}({},m,n),{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"user-stories"},"User stories"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"As a WiX Developer I can add methods (or add parameters to methods) to the Burn API such that WiX Users can continue to compile their custom Bootstrapper Application after upgrading the WiX Toolset without making any changes (adding methods and adding parameters are never breaking changes).")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"As a WiX User I can use my compiled custom Bootstrapper Application with any later version of the WiX Toolset with the same major version (the Burn API will maintain binary compatibility)."))),(0,o.kt)("h2",{id:"background"},"Background"),(0,o.kt)("p",null,"The Burn engine works with the Bootstrapper Application to handle the Bundle's installation operations.\nThe unelevated engine and the BA live in the same process.\nThere needed to be a way for the engine and the BA to communicate to each other, and it had to be something that unmanaged code could use as well as managed."),(0,o.kt)("p",null,'In the first version of Burn (WiX v3.x), the engine exposed its functionality through the IBootstrapperEngine COM interface, and called into the BA through the IBootstrapperApplication COM interface.\nAs newer version were released, methods were added and modified to IBootstrapperApplication.\nThe first changes were in v3.7, they modified existing methods and added new ones.\nDue to the feedback from WiX Users when upgrading, the WiX team tried to leave the interfaces alone.\nIn v3.9, the WiX team allowed some new methods to be added as well as adding a default parameter to an existing method (maintaining "compile time" compatibility but not binary compatibility).\nThis brought in multiple bug reports from users where their bundle crashed because of compiling their BA against the wrong version of the toolset.'),(0,o.kt)("h2",{id:"proposal"},"Proposal"),(0,o.kt)("p",null,"I propose that Burn offers two options when developing a custom BA: message based or interface based.\nUsing messages with structs that have a cbSize member is a proven way to maintain an API that can be extended over time.\nThis also gives the benefit of maintaining binary compatibility between releases.\nThe interface option would be an abstraction layer provided by the toolset to hide the fact that the engine is sending messages instead of making calls on a COM interface."),(0,o.kt)("p",null,"I propose that we swap the guarantees we give today on the interfaces: a BA compiled to the COM interface will be binary compatible to future releases, but the interface can be changed between releases.\nSince the COM interfaces will use the messages behind the scenes, binary compatibility is free.\nI believe that WiX Users would be willing to accept that upgrading the toolset that the BA is compiled against may require modification of their source code, because they could upgrade the Bundle's toolset independently of the BA's toolset (since they'll probably use Nuget to provide the headers for their BA)."),(0,o.kt)("h2",{id:"native-ba"},"Native BA"),(0,o.kt)("h3",{id:"wix-3x"},"WiX 3.x"),(0,o.kt)("p",null,"The native BA would link in the ",(0,o.kt)("inlineCode",{parentName:"p"},"balutil")," library and implement ",(0,o.kt)("inlineCode",{parentName:"p"},"IBootstrapperApplication")," by extending from ",(0,o.kt)("inlineCode",{parentName:"p"},"BalBaseBootstrapperApplication"),".\nThe BA would return this ",(0,o.kt)("inlineCode",{parentName:"p"},"IBootstrapperApplication")," to the engine from ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperApplicationCreate"),".\nIn the bundle authoring, the BA dll would be used as the ",(0,o.kt)("inlineCode",{parentName:"p"},"SourceFile")," in the ",(0,o.kt)("inlineCode",{parentName:"p"},"BoostrapperApplication")," element."),(0,o.kt)("h3",{id:"wix-4x"},"WiX 4.x"),(0,o.kt)("p",null,"The native BA links in the ",(0,o.kt)("inlineCode",{parentName:"p"},"balutil")," library from the WixToolset.BalUtil nuget package.\nThis requires also bringing in the WixToolset.BootstrapperCore.Native nuget package.\nThe BA gets an ",(0,o.kt)("inlineCode",{parentName:"p"},"IBootstrapperEngine")," instance by passing in the ",(0,o.kt)("inlineCode",{parentName:"p"},"BOOTSTRAPPER_CREATE_ARGS")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"BalInitializeFromCreateArgs"),".\nThe BA still implements ",(0,o.kt)("inlineCode",{parentName:"p"},"IBootstrapperApplication")," by extending from ",(0,o.kt)("inlineCode",{parentName:"p"},"BalBaseBootstrapperApplication"),".\nIn ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperApplicationCreate"),", the BA sets ",(0,o.kt)("inlineCode",{parentName:"p"},"pfnBootstrapperApplicationProc")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"BalBaseBootstrapperApplicationProc")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"pvBootstrapperApplicationProcContext")," to their BA.\nIn the bundle authoring, the BA dll is still used as the ",(0,o.kt)("inlineCode",{parentName:"p"},"SourceFile")," in the ",(0,o.kt)("inlineCode",{parentName:"p"},"BoostrapperApplication")," element.\nWhen implemented this way, upgrading to a new version of WixToolset.BalUtil in the same major version would only potentially be a breaking change if a new parameter is added to an existing method in ",(0,o.kt)("inlineCode",{parentName:"p"},"IBootstrapperApplication")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"IBootstrapperEngine"),".\nAn example of a real native BA is ",(0,o.kt)("inlineCode",{parentName:"p"},"wixstdba")," in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wixtoolset/Bal.wixext/tree/master/src/wixstdba"},"BalExtension"),"."),(0,o.kt)("p",null,'It is technically possible to write a native BA against the message based API instead of the COM API.\nThis kind of BA would get both "compile-time" compatibility and binary compatibility.\nIt is expected to be very rare to choose this.'),(0,o.kt)("h2",{id:"managed-ba"},"Managed BA"),(0,o.kt)("h3",{id:"wix-3x-1"},"WiX 3.x"),(0,o.kt)("p",null,"The toolset only had support for a managed BA written in .NET Framework, not .NET Core.\nThe BA would reference ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperCore.dll")," and create a subclass of ",(0,o.kt)("inlineCode",{parentName:"p"},"Microsoft.Tools.WindowsInstallerXml.Bootstrapper.BootstrapperApplication"),".\nThe BA would use this subclass's type in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Microsoft.Tools.WindowsInstallerXml.Bootstrapper.BootstrapperApplicationAttribute")," assembly attribute.\nThe BA would include this assembly's name and target .NET Framework in a .NET Framework .config file.\nIn the bundle authoring, the BA dll would be included as a payload in a ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperApplicationRef")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"ManagedBootstrapperApplicationHost"),".\nThe .config file would also be a payload there, with the required name of ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperCore.config"),".\nAll of the BA's dependencies were also required as payloads there, with the exception of ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperCore.dll"),".\nThe BalExtension injected its version of ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperCore.dll"),"."),(0,o.kt)("h3",{id:"wix-4x-1"},"WiX 4.x"),(0,o.kt)("p",null,"The toolset has support for both .NET Framework and .NET Core.\n",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperCore.dll")," has been broken up.\nThe host specific code has been moved to ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Host.dll")," (",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Dnc.Host.dll")," for .NET Core), and the rest into ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.dll"),".\n",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.dll")," relies on the new native ",(0,o.kt)("inlineCode",{parentName:"p"},"mbanative.dll")," for the mapping of messages to the COM interfaces.\n",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.dll")," (and ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Host.dll"),") targets .NET Framework 2.0 to be able to support managed BAs on all supported .NET platforms.\n",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Dnc.Host.dll")," targets .NET Core 3.0, since that version of the framework added UI frameworks and sufficiently high-level custom hosting APIs."),(0,o.kt)("p",null,"The BA references ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.dll")," from the WixToolset.Mba.Core nuget package.\nThe BA creates a subclass of ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.BootstrapperApplication"),".\nThe BA creates a subclass of ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.BaseBootstrapperApplicationFactory"),".\nThe BA uses this subclass's type in the ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.BaseBootstrapperApplicationFactoryAttribute")," assembly attribute."),(0,o.kt)("h4",{id:"net-framework"},".NET Framework"),(0,o.kt)("p",null,"The BA includes this assembly's name and target .NET Framework in a .NET Framework .config file.\nIn the bundle authoring, the BA dll is included as a payload in a ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperApplicationRef")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"ManagedBootstrapperApplicationHost"),".\nThe .config file is also be a payload there, with the required name of ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Host.config"),".\nAll of the BA's dependencies are also required as payloads there, including ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.dll")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"mbanative.dll"),".\nThe BalExtension injects its version of ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Host.dll"),"."),(0,o.kt)("h4",{id:"net-core"},".NET Core"),(0,o.kt)("p",null,"The BA project must be an application, not a library (target netcoreapp3.0 or later, not netstandard).\nThe BA project must be published, not only built.\nThe BA project must have ",(0,o.kt)("inlineCode",{parentName:"p"},"EnableDynamicLoading")," set to ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," so the SDK generates the .runtimeconfig.json file.\nIf the BA project has ",(0,o.kt)("inlineCode",{parentName:"p"},"PublishTrimmed")," set to true, it must have ",(0,o.kt)("inlineCode",{parentName:"p"},'<TrimmerRootAssembly Include="System.Runtime.Loader" />')," since the host requires it.\nIn the bundle authoring, the BA dll is included as a payload in a ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperApplicationRef")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"DotNetCoreBootstrapperApplicationHost")," with the attribute ",(0,o.kt)("inlineCode",{parentName:"p"},"bal:BAFactoryAssembly")," set to ",(0,o.kt)("inlineCode",{parentName:"p"},"yes"),".\nThe .deps.json, .runtimeconfig.json, and all dependencies are also required as payloads there, including ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Mba.Core.dll")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"mbanative.dll"),".\nIf published as self-contained, the ",(0,o.kt)("inlineCode",{parentName:"p"},"SelfContainedDeployment")," attribute must be set to ",(0,o.kt)("inlineCode",{parentName:"p"},"yes")," on the ",(0,o.kt)("inlineCode",{parentName:"p"},"bal:WixDotNetCoreBootstrapperApplication")," element.\nThe BalExtension injects its version of ",(0,o.kt)("inlineCode",{parentName:"p"},"WixToolset.Dnc.Host.dll"),"."),(0,o.kt)("h4",{id:"both-runtimes"},"Both runtimes"),(0,o.kt)("p",null,"When implemented this way, upgrading to new versions of WixToolset.Mba.Core shouldn't be breaking since ",(0,o.kt)("inlineCode",{parentName:"p"},"BootstrapperApplication")," exposes the interface as events.\nThere are no real managed BA's in v4, but there are examples of .NET Framework 2.0, .NET Framework 4.0, and .NET Core in the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wixtoolset/Bal.wixext/tree/master/src/test"},"BalExtension tests"),"."),(0,o.kt)("h2",{id:"considerations"},"Considerations"),(0,o.kt)("h2",{id:"see-also"},"See Also"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"http://wixtoolset.org/issues/4773/"},"Issue 4773")))}h.isMDXComponent=!0}}]);