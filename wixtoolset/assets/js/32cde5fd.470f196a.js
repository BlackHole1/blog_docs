"use strict";(self.webpackChunkwixweb=self.webpackChunkwixweb||[]).push([[33208],{3905:(e,t,r)=>{r.d(t,{Zo:()=>d,kt:()=>b});var n=r(67294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var s=n.createContext({}),p=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(r),h=o,b=u["".concat(s,".").concat(h)]||u[h]||c[h]||a;return r?n.createElement(b,i(i({ref:t},d),{},{components:r})):n.createElement(b,i({ref:t},d))}));function b(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=r.length,i=new Array(a);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<a;p++)i[p]=r[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"},29066:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>b,frontMatter:()=>l,metadata:()=>p,toc:()=>u});r(67294);var n=r(3905);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function i(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}const l={wip:6145,type:"Feature",by:"Sean Hall (rseanhall at gmail.com)",title:"Burn restart with elevated process",draft:!1},s=void 0,p={unversionedId:"development/wips/burn-restart-with-elevated-process",id:"development/wips/burn-restart-with-elevated-process",title:"Burn restart with elevated process",description:"User stories",source:"@site/docs/development/wips/6145-burn-restart-with-elevated-process.md",sourceDirName:"development/wips",slug:"/development/wips/burn-restart-with-elevated-process",permalink:"/wixtoolset/docs/development/wips/burn-restart-with-elevated-process",draft:!1,editUrl:"https://github.com/wixtoolset/web/tree/master/src/Docusaurus/docs/development/wips/6145-burn-restart-with-elevated-process.md",tags:[],version:"current",sidebarPosition:6145,frontMatter:{wip:6145,type:"Feature",by:"Sean Hall (rseanhall at gmail.com)",title:"Burn restart with elevated process",draft:!1},sidebar:"docsSidebar",previous:{title:".NET Core BA",permalink:"/wixtoolset/docs/development/wips/dotnet-core-scd-ba"},next:{title:"Move DisplayInternalUI from Core to BalExtension",permalink:"/wixtoolset/docs/development/wips/move-displayinternalui-from-core-to-bal"}},d={},u=[{value:"User stories",id:"user-stories",level:2},{value:"Background",id:"background",level:2},{value:"Proposal 1 - Use elevated engine",id:"proposal-1---use-elevated-engine",level:2},{value:"Considerations for Proposal 1",id:"considerations-for-proposal-1",level:2},{value:"Proposal 2 - Add new elevation mode",id:"proposal-2---add-new-elevation-mode",level:2},{value:"Considerations for Proposal 2",id:"considerations-for-proposal-2",level:2},{value:"Proposal 3 - Use shutdown.exe",id:"proposal-3---use-shutdownexe",level:2},{value:"Considerations for Proposal 3",id:"considerations-for-proposal-3",level:2},{value:"See Also",id:"see-also",level:2}],c={toc:u},h="wrapper";function b(e){var{components:t}=e,r=i(e,["components"]);return(0,n.kt)(h,a(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){o(e,t,r[t])}))}return e}({},c,r),{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h2",{id:"user-stories"},"User stories"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"As a setup developer I can build a Burn bundle such that it can restart on hardened machines where the unelevated process doesn't have the privilege to shutdown the machine.")),(0,n.kt)("h2",{id:"background"},"Background"),(0,n.kt)("p",null,"On Windows, the process token must have the SE_SHUTDOWN_NAME privilege enabled in order to request that the machine be shutdown or restarted.\nThe default configuration on client OS's (for example, Windows 11) gives this privilege to elevated admins, unelevated admins, and non-admins.\nThe default configuration on server OS's (for example, Server 2022) has gradually removed this privilege except from elevated admins.\nThis means that Burn bundles have been failing to request a restart on a growing number of machines."),(0,n.kt)("p",null,"All proposals below require the ability to create an elevated process.\nUnder certain configurations of Windows, Burn will not have that ability.\nBy the time that the engine realizes that the restart request has failed, the BA is no longer available.\nUnless Burn is going to pop up a message box itself, the only thing it can do is log the error."),(0,n.kt)("h2",{id:"proposal-1---use-elevated-engine"},"Proposal 1 - Use elevated engine"),(0,n.kt)("p",null,"Most bundles that want to restart will have already started an elevated engine.\nUnder this proposal, the unelevated process will tell the elevated engine to request the restart instead of making the request itself.\nIf the bundle never started an elevated engine, then it will attempt to request the restart like it does today."),(0,n.kt)("p",null,"To help BA's know whether the bundle will require an elevated engine to restart, a new built-in variable, ",(0,n.kt)("inlineCode",{parentName:"p"},"WixCanRestart"),", will be added.\nIf that variable is false, the built-in BA's will be updated to show the UAC shield on the Restart button and call IBootstrapperEngine::Elevate if necessary before shutting down."),(0,n.kt)("h2",{id:"considerations-for-proposal-1"},"Considerations for Proposal 1"),(0,n.kt)("p",null,"This proposal is the most user friendly since most bundles that want to restart will have already started an elevated engine, so there should be at most one UAC prompt."),(0,n.kt)("p",null,"Adding the ability for the unelevated engine to tell the elevated engine to request a restart is technically a privilege escalation vulnerability and a denial of service risk.\nWhile mitigations like requiring that the elevated engine ran a package that required a restart could be added, I don't think it's worth worrying about.\nAn attacker would require code execution to exploit this vulnerability as well as a user that accepts the UAC prompt."),(0,n.kt)("h2",{id:"proposal-2---add-new-elevation-mode"},"Proposal 2 - Add new elevation mode"),(0,n.kt)("p",null,"The same ",(0,n.kt)("inlineCode",{parentName:"p"},"WixCanRestart")," built-in variable as in Proposal 1 will be added.\nIf that variable is false, the built-in BA's will be updated to show the UAC shield on the Restart button."),(0,n.kt)("p",null,"If that variable is false, the unelevated engine will use ",(0,n.kt)("inlineCode",{parentName:"p"},"ShellExecuteEx")," and the ",(0,n.kt)("inlineCode",{parentName:"p"},"runas")," verb to run ",(0,n.kt)("inlineCode",{parentName:"p"},"{bundle}.exe -burn.restartnow")," instead of programmatically requesting the restart."),(0,n.kt)("h2",{id:"considerations-for-proposal-2"},"Considerations for Proposal 2"),(0,n.kt)("p",null,"This proposal would always require an additional UAC prompt.\nIt may be confusing to the user why the bundle wants to elevate itself multiple times."),(0,n.kt)("h2",{id:"proposal-3---use-shutdownexe"},"Proposal 3 - Use shutdown.exe"),(0,n.kt)("p",null,"The same ",(0,n.kt)("inlineCode",{parentName:"p"},"WixCanRestart")," built-in variable as in Proposal 1 will be added.\nIf that variable is false, the built-in BA's will be updated to show the UAC shield on the Restart button."),(0,n.kt)("p",null,"If that variable is false, the unelevated engine will use ",(0,n.kt)("inlineCode",{parentName:"p"},"ShellExecuteEx")," and the ",(0,n.kt)("inlineCode",{parentName:"p"},"runas")," verb to run ",(0,n.kt)("inlineCode",{parentName:"p"},"shutdown.exe /r /d p:4:2")," instead of programmatically requesting the restart."),(0,n.kt)("h2",{id:"considerations-for-proposal-3"},"Considerations for Proposal 3"),(0,n.kt)("p",null,"This proposal would always require an additional UAC prompt, but it should always be a trusted program since it should be signed by Microsoft."),(0,n.kt)("p",null,"This proposal relies on ",(0,n.kt)("inlineCode",{parentName:"p"},"shutdown.exe")," being available and not blocked by policy."),(0,n.kt)("h2",{id:"see-also"},"See Also"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"http://github.com/wixtoolset/issues/issues/6145"},"WIXFEAT:6145"),"\n",(0,n.kt)("a",{parentName:"p",href:"http://github.com/wixtoolset/issues/issues/5499"},"WIXFEAT:5499"),"\n",(0,n.kt)("a",{parentName:"p",href:"http://github.com/wixtoolset/issues/issues/5650"},"WIXFEAT:5650")))}b.isMDXComponent=!0}}]);