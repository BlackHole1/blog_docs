<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>systemd-cryptenroll</title><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><script src="https://code.jquery.com/jquery-3.7.1.min.js"></script><script src="../nav.js"></script><style>
    a.headerlink {
      color: #c60f0f;
      font-size: 0.8em;
      padding: 0 4px 0 4px;
      text-decoration: none;
      visibility: hidden;
    }

    a.headerlink:hover {
      background-color: #c60f0f;
      color: white;
    }

    h1:hover > a.headerlink, h2:hover > a.headerlink, h3:hover > a.headerlink, dt:hover > a.headerlink {
      visibility: visible;
    }
  </style><a href="index.html">Index </a>·
  <a href="systemd.directives.html">Directives </a><span style="float:right">systemd 255</span><hr><div class="refentry"><a name="systemd-cryptenroll"></a><div class="titlepage"></div><div class="refnamediv"><h2>Name</h2><p>systemd-cryptenroll — Enroll PKCS#11, FIDO2, TPM2 token/devices to LUKS2 encrypted volumes</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><div class="cmdsynopsis"><p><code class="command">systemd-cryptenroll</code>  [OPTIONS...] [DEVICE]</p></div></div><div class="refsect1"><a name="id-1.5"></a><h2 id="Description">Description<a class="headerlink" title="Permalink to this headline" href="#Description">¶</a></h2><p><span class="command"><strong>systemd-cryptenroll</strong></span> is a tool for enrolling hardware security tokens and devices
    into a LUKS2 encrypted volume, which may then be used to unlock the volume during boot. Specifically, it
    supports tokens and credentials of the following kind to be enrolled:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>PKCS#11 security tokens and smartcards that may carry an RSA key pair (e.g. various
      YubiKeys)</p></li><li class="listitem"><p>FIDO2 security tokens that implement the "<code class="literal">hmac-secret</code>" extension (most
      FIDO2 keys, including YubiKeys)</p></li><li class="listitem"><p>TPM2 security devices</p></li><li class="listitem"><p>Regular passphrases</p></li><li class="listitem"><p>Recovery keys. These are similar to regular passphrases, however are randomly generated
      on the computer and thus generally have higher entropy than user-chosen passphrases. Their character
      set has been designed to ensure they are easy to type in, while having high entropy. They may also be
      scanned off screen using QR codes. Recovery keys may be used for unlocking LUKS2 volumes wherever
      passphrases are accepted. They are intended to be used in combination with an enrolled hardware
      security token, as a recovery option when the token is lost.</p></li></ol></div><p>In addition, the tool may be used to enumerate currently enrolled security tokens and wipe a subset
    of them. The latter may be combined with the enrollment operation of a new security token, in order to
    update or replace enrollments.</p><p>The tool supports only LUKS2 volumes, as it stores token meta-information in the LUKS2 JSON token
    area, which is not available in other encryption formats.</p><div class="refsect2"><a name="id-1.5.6"></a><h3 id="TPM2 PCRs and policies">TPM2 PCRs and policies<a class="headerlink" title="Permalink to this headline" href="#TPM2%20PCRs%20and%20policies">¶</a></h3><p>PCRs allow binding of the encryption of secrets to specific software versions and system state,
      so that the enrolled key is only accessible (may be "unsealed") if specific trusted software and/or
      configuration is used. Such bindings may be created with the option <code class="option">--tpm2-pcrs=</code>
      described below.</p><p>Secrets may also be bound indirectly: a signed policy for a state of some combination of PCR
      values is provided, and the secret is bound to the public part of the key used to sign this policy.
      This means that the owner of a key can generate a sequence of signed policies, for specific software
      versions and system states, and the secret can be decrypted as long as the machine state matches one of
      those policies. For example, a vendor may provide such a policy for each kernel+initrd update, allowing
      users to encrypt secrets so that they can be decrypted when running any kernel+initrd signed by the
      vendor. Such bindings may be created with the options <code class="option">--tpm2-public-key=</code>,
      <code class="option">--tpm2-public-key-pcrs=</code>, <code class="option">--tpm2-signature=</code> described below.
      </p><p>See <a class="ulink" href="https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/" target="_top">Linux TPM
      PCR Registry</a> for an authoritative list of PCRs and how they are updated. The table below
      contains a quick reference, describing in particular the PCRs modified by systemd.</p><div class="table"><a name="id-1.5.6.5"></a><p class="title"><b>Table 1. Well-known PCR Definitions</b></p><div class="table-contents"><table class="table" summary="Well-known PCR Definitions" border="1"><colgroup><col align="left" class="pcr"><col align="left" class="name"><col align="left" class="definition"></colgroup><thead><tr><th align="left">PCR</th><th align="left">name</th><th align="left">Explanation</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">platform-code</td><td align="left">Core system firmware executable code; changes on firmware updates</td></tr><tr><td align="left">1</td><td align="left">platform-config</td><td align="left">Core system firmware data/host platform configuration; typically contains serial and model numbers, changes on basic hardware/CPU/RAM replacements</td></tr><tr><td align="left">2</td><td align="left">external-code</td><td align="left">Extended or pluggable executable code; includes option ROMs on pluggable hardware</td></tr><tr><td align="left">3</td><td align="left">external-config</td><td align="left">Extended or pluggable firmware data; includes information about pluggable hardware</td></tr><tr><td align="left">4</td><td align="left">boot-loader-code</td><td align="left">Boot loader and additional drivers, PE binaries invoked by the boot loader; changes on boot loader updates. <a href="sd-stub.html#"><span class="citerefentry"><span class="refentrytitle">sd-stub</span>(7)</span></a> measures system extension images read from the ESP here too (see <a href="systemd-sysext.html#"><span class="citerefentry"><span class="refentrytitle">systemd-sysext</span>(8)</span></a>).</td></tr><tr><td align="left">5</td><td align="left">boot-loader-config</td><td align="left">GPT/Partition table; changes when the partitions are added, modified, or removed</td></tr><tr><td align="left">7</td><td align="left">secure-boot-policy</td><td align="left">Secure Boot state; changes when UEFI SecureBoot mode is enabled/disabled, or firmware certificates (PK, KEK, db, dbx, …) changes.</td></tr><tr><td align="left">9</td><td align="left">kernel-initrd</td><td align="left">The Linux kernel measures all initrds it receives into this PCR.</td></tr><tr><td align="left">10</td><td align="left">ima</td><td align="left">The IMA project measures its runtime state into this PCR.</td></tr><tr><td align="left">11</td><td align="left">kernel-boot</td><td align="left"><a href="systemd-stub.html#"><span class="citerefentry"><span class="refentrytitle">systemd-stub</span>(7)</span></a> measures the ELF kernel image, embedded initrd and other payload of the PE image it is placed in into this PCR. <a href="systemd-pcrphase.service.html#"><span class="citerefentry"><span class="refentrytitle">systemd-pcrphase.service</span>(8)</span></a> measures boot phase strings into this PCR at various milestones of the boot process.</td></tr><tr><td align="left">12</td><td align="left">kernel-config</td><td align="left"><a href="systemd-boot.html#"><span class="citerefentry"><span class="refentrytitle">systemd-boot</span>(7)</span></a> measures the kernel command line into this PCR. <a href="systemd-stub.html#"><span class="citerefentry"><span class="refentrytitle">systemd-stub</span>(7)</span></a> measures any manually specified kernel command line (i.e. a kernel command line that overrides the one embedded in the unified PE image) and loaded credentials into this PCR.</td></tr><tr><td align="left">13</td><td align="left">sysexts</td><td align="left"><a href="systemd-stub.html#"><span class="citerefentry"><span class="refentrytitle">systemd-stub</span>(7)</span></a> measures any <a href="systemd-sysext.html#"><span class="citerefentry"><span class="refentrytitle">systemd-sysext</span>(8)</span></a> images it passes to the booted kernel into this PCR.</td></tr><tr><td align="left">14</td><td align="left">shim-policy</td><td align="left">The shim project measures its "MOK" certificates and hashes into this PCR.</td></tr><tr><td align="left">15</td><td align="left">system-identity</td><td align="left"><a href="systemd-cryptsetup.html#"><span class="citerefentry"><span class="refentrytitle">systemd-cryptsetup</span>(8)</span></a> optionally measures the volume key of activated LUKS volumes into this PCR. <a href="systemd-pcrmachine.service.html#"><span class="citerefentry"><span class="refentrytitle">systemd-pcrmachine.service</span>(8)</span></a> measures the <a href="machine-id.html#"><span class="citerefentry"><span class="refentrytitle">machine-id</span>(5)</span></a> into this PCR. <a href="systemd-pcrfs@.service.html#"><span class="citerefentry"><span class="refentrytitle">systemd-pcrfs@.service</span>(8)</span></a> measures mount points, file system UUIDs, labels, partition UUIDs of the root and <code class="filename">/var/</code> filesystems into this PCR.</td></tr><tr><td align="left">16</td><td align="left">debug</td><td align="left">Debug</td></tr><tr><td align="left">23</td><td align="left">application-support</td><td align="left">Application Support</td></tr></tbody></table></div></div><br class="table-break"><p>In general, encrypted volumes would be bound to some combination of PCRs 7, 11, and 14 (if
      shim/MOK is used). In order to allow firmware and OS version updates, it is typically not advisable to
      use PCRs such as 0 and 2, since the program code they cover should already be covered indirectly
      through the certificates measured into PCR 7. Validation through certificates hashes is typically
      preferable over validation through direct measurements as it is less brittle in context of OS/firmware
      updates: the measurements will change on every update, but signatures should remain unchanged. See the
      <a class="ulink" href="https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/" target="_top">Linux TPM PCR
      Registry</a> for more discussion.</p></div></div><div class="refsect1"><a name="id-1.6"></a><h2 id="Limitations">Limitations<a class="headerlink" title="Permalink to this headline" href="#Limitations">¶</a></h2><p>Note that currently when enrolling a new key of one of the five supported types listed above, it is
    required to first provide a passphrase, a recovery key or a FIDO2 token. It's currently not supported to
    unlock a device with a TPM2/PKCS#11 key in order to enroll a new TPM2/PKCS#11 key. Thus, if in future key
    roll-over is desired it's generally recommended to ensure a passphrase, a recovery key or a FIDO2 token
    is always enrolled.</p><p>Also note that support for enrolling multiple FIDO2 tokens is currently limited. When multiple FIDO2
    tokens are enrolled, <span class="command"><strong>systemd-cryptseup</strong></span> will perform pre-flight requests to attempt to
    identify which of the enrolled tokens are currently plugged in. However, this is not possible for FIDO2
    tokens with user verification (UV, usually via biometrics), in which case it will fall back to attempting
    each enrolled token one by one. This will result in multiple prompts for PIN and user verification. This
    limitation does not apply to PKCS#11 tokens.</p></div><div class="refsect1"><a name="id-1.7"></a><h2 id="Compatibility">Compatibility<a class="headerlink" title="Permalink to this headline" href="#Compatibility">¶</a></h2><p>Security technology both in systemd and in the general industry constantly evolves. In order to
    provide best security guarantees, the way TPM2, FIDO2, PKCS#11 devices are enrolled is regularly updated
    in newer versions of systemd. Whenever this happens the following compatibility guarantees are given:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Old enrollments continue to be supported and may be unlocked with newer versions of
      <a href="systemd-cryptsetup@.service.html#"><span class="citerefentry"><span class="refentrytitle">systemd-cryptsetup@.service</span>(8)</span></a>.</p></li><li class="listitem"><p>The opposite is not guaranteed however: it might not be possible to unlock volumes with
      enrollments done with a newer version of <span class="command"><strong>systemd-cryptenroll</strong></span> with an older version
      of <span class="command"><strong>systemd-cryptsetup</strong></span>.</p></li></ul></div><p>That said, it is generally recommended to use matching versions of
    <span class="command"><strong>systemd-cryptenroll</strong></span> and <span class="command"><strong>systemd-cryptsetup</strong></span>, since this is best
    tested and supported.</p><p>It might be advisable to re-enroll existing enrollments to take benefit of newer security features,
    as they are added to systemd.</p></div><div class="refsect1"><a name="id-1.8"></a><h2 id="Options">Options<a class="headerlink" title="Permalink to this headline" href="#Options">¶</a></h2><p>The following options are understood:</p><div class="variablelist"><dl class="variablelist"><dt id="--password"><span class="term"><code class="option">--password</code></span><a class="headerlink" title="Permalink to this term" href="#--password">¶</a></dt><dd><p>Enroll a regular password/passphrase. This command is mostly equivalent to
        <span class="command"><strong>cryptsetup luksAddKey</strong></span>, however may be combined with
        <code class="option">--wipe-slot=</code> in one call, see below.</p><p><a name="v248"></a>Added in version 248.</p></dd><dt id="--recovery-key"><span class="term"><code class="option">--recovery-key</code></span><a class="headerlink" title="Permalink to this term" href="#--recovery-key">¶</a></dt><dd><p>Enroll a recovery key. Recovery keys are mostly identical to passphrases, but are
        computer-generated instead of being chosen by a human, and thus have a guaranteed high entropy. The
        key uses a character set that is easy to type in, and may be scanned off screen via a QR code.
        </p><p><a name="v248"></a>Added in version 248.</p></dd><dt id="--unlock-key-file=PATH"><span class="term"><code class="option">--unlock-key-file=</code><em class="replaceable"><code>PATH</code></em></span><a class="headerlink" title="Permalink to this term" href="#--unlock-key-file=PATH">¶</a></dt><dd><p>Use a file instead of a password/passphrase read from stdin to unlock the volume.
        Expects the PATH to the file containing your key to unlock the volume. Currently there is nothing like
        <code class="option">--key-file-offset=</code> or <code class="option">--key-file-size=</code> so this file has to only
        contain the full key.</p><p><a name="v252"></a>Added in version 252.</p></dd><dt id="--unlock-fido2-device=PATH"><span class="term"><code class="option">--unlock-fido2-device=</code><em class="replaceable"><code>PATH</code></em></span><a class="headerlink" title="Permalink to this term" href="#--unlock-fido2-device=PATH">¶</a></dt><dd><p>Use a FIDO2 device instead of a password/passphrase read from stdin to unlock the
        volume. Expects a <code class="filename">hidraw</code> device referring to the FIDO2 device (e.g.
        <code class="filename">/dev/hidraw1</code>). Alternatively the special value "<code class="literal">auto</code>" may be
        specified, in order to automatically determine the device node of a currently plugged in security
        token (of which there must be exactly one). This automatic discovery is unsupported if
        <code class="option">--fido2-device=</code> option is also specified.</p><p><a name="v253"></a>Added in version 253.</p></dd><dt id="--pkcs11-token-uri=URI"><span class="term"><code class="option">--pkcs11-token-uri=</code><em class="replaceable"><code>URI</code></em></span><a class="headerlink" title="Permalink to this term" href="#--pkcs11-token-uri=URI">¶</a></dt><dd><p>Enroll a PKCS#11 security token or smartcard (e.g. a YubiKey). Expects a PKCS#11
        smartcard URI referring to the token. Alternatively the special value "<code class="literal">auto</code>" may
        be specified, in order to automatically determine the URI of a currently plugged in security token
        (of which there must be exactly one). The special value "<code class="literal">list</code>" may be used to
        enumerate all suitable PKCS#11 tokens currently plugged in. The security token must contain an RSA
        key pair which is used to encrypt the randomly generated key that is used to unlock the LUKS2
        volume. The encrypted key is then stored in the LUKS2 JSON token header area.</p><p>In order to unlock a LUKS2 volume with an enrolled PKCS#11 security token, specify the
        <code class="option">pkcs11-uri=</code> option in the respective <code class="filename">/etc/crypttab</code> line:</p><pre class="programlisting">myvolume /dev/sda1 - pkcs11-uri=auto</pre><p>See
        <a href="crypttab.html#"><span class="citerefentry"><span class="refentrytitle">crypttab</span>(5)</span></a> for a
        more comprehensive example of a <span class="command"><strong>systemd-cryptenroll</strong></span> invocation and its matching
        <code class="filename">/etc/crypttab</code> line.</p><p><a name="v248"></a>Added in version 248.</p></dd><dt id="--fido2-credential-algorithm=STRING"><span class="term"><code class="option">--fido2-credential-algorithm=</code><em class="replaceable"><code>STRING</code></em></span><a class="headerlink" title="Permalink to this term" href="#--fido2-credential-algorithm=STRING">¶</a></dt><dd><p>Specify COSE algorithm used in credential generation. The default value is
        "<code class="literal">es256</code>". Supported values are "<code class="literal">es256</code>", "<code class="literal">rs256</code>"
        and "<code class="literal">eddsa</code>".</p><p>"<code class="literal">es256</code>" denotes ECDSA over NIST P-256 with SHA-256. "<code class="literal">rs256</code>"
        denotes 2048-bit RSA with PKCS#1.5 padding and SHA-256. "<code class="literal">eddsa</code>" denotes
        EDDSA over Curve25519 with SHA-512.</p><p>Note that your authenticator may not support some algorithms.</p><p><a name="v251"></a>Added in version 251.</p></dd><dt id="--fido2-device=PATH"><span class="term"><code class="option">--fido2-device=</code><em class="replaceable"><code>PATH</code></em></span><a class="headerlink" title="Permalink to this term" href="#--fido2-device=PATH">¶</a></dt><dd><p>Enroll a FIDO2 security token that implements the "<code class="literal">hmac-secret</code>"
        extension (e.g. a YubiKey). Expects a <code class="filename">hidraw</code> device referring to the FIDO2
        device (e.g. <code class="filename">/dev/hidraw1</code>). Alternatively the special value
        "<code class="literal">auto</code>" may be specified, in order to automatically determine the device node of a
        currently plugged in security token (of which there must be exactly one). This automatic discovery
        is unsupported if <code class="option">--unlock-fido2-device=</code> option is also specified. The special value
        "<code class="literal">list</code>" may be used to enumerate all suitable FIDO2 tokens currently plugged in. Note
        that many hardware security tokens that implement FIDO2 also implement the older PKCS#11
        standard. Typically FIDO2 is preferable, given it's simpler to use and more modern.</p><p>In order to unlock a LUKS2 volume with an enrolled FIDO2 security token, specify the
        <code class="option">fido2-device=</code> option in the respective <code class="filename">/etc/crypttab</code> line:</p><pre class="programlisting">myvolume /dev/sda1 - fido2-device=auto</pre><p>See
        <a href="crypttab.html#"><span class="citerefentry"><span class="refentrytitle">crypttab</span>(5)</span></a> for a
        more comprehensive example of a <span class="command"><strong>systemd-cryptenroll</strong></span> invocation and its matching
        <code class="filename">/etc/crypttab</code> line.</p><p><a name="v248"></a>Added in version 248.</p></dd><dt id="--fido2-with-client-pin=BOOL"><span class="term"><code class="option">--fido2-with-client-pin=</code><em class="replaceable"><code>BOOL</code></em></span><a class="headerlink" title="Permalink to this term" href="#--fido2-with-client-pin=BOOL">¶</a></dt><dd><p>When enrolling a FIDO2 security token, controls whether to require the user to enter
        a PIN when unlocking the volume (the FIDO2 "<code class="literal">clientPin</code>" feature). Defaults to
        "<code class="literal">yes</code>". (Note: this setting is without effect if the security token does not support
        the "<code class="literal">clientPin</code>" feature at all, or does not allow enabling or disabling
        it.)</p><p><a name="v249"></a>Added in version 249.</p></dd><dt id="--fido2-with-user-presence=BOOL"><span class="term"><code class="option">--fido2-with-user-presence=</code><em class="replaceable"><code>BOOL</code></em></span><a class="headerlink" title="Permalink to this term" href="#--fido2-with-user-presence=BOOL">¶</a></dt><dd><p>When enrolling a FIDO2 security token, controls whether to require the user to
        verify presence (tap the token, the FIDO2 "<code class="literal">up</code>" feature) when unlocking the volume.
        Defaults to "<code class="literal">yes</code>". (Note: this setting is without effect if the security token does not support
        the "<code class="literal">up</code>" feature at all, or does not allow enabling or disabling it.)
        </p><p><a name="v249"></a>Added in version 249.</p></dd><dt id="--fido2-with-user-verification=BOOL"><span class="term"><code class="option">--fido2-with-user-verification=</code><em class="replaceable"><code>BOOL</code></em></span><a class="headerlink" title="Permalink to this term" href="#--fido2-with-user-verification=BOOL">¶</a></dt><dd><p>When enrolling a FIDO2 security token, controls whether to require user verification
        when unlocking the volume (the FIDO2 "<code class="literal">uv</code>" feature). Defaults to
        "<code class="literal">no</code>". (Note: this setting is without effect if the security token does not support
        the "<code class="literal">uv</code>" feature at all, or does not allow enabling or disabling it.)</p><p><a name="v249"></a>Added in version 249.</p></dd><dt id="--tpm2-device=PATH"><span class="term"><code class="option">--tpm2-device=</code><em class="replaceable"><code>PATH</code></em></span><a class="headerlink" title="Permalink to this term" href="#--tpm2-device=PATH">¶</a></dt><dd><p>Enroll a TPM2 security chip. Expects a device node path referring to the TPM2 chip
        (e.g. <code class="filename">/dev/tpmrm0</code>). Alternatively the special value "<code class="literal">auto</code>" may
        be specified, in order to automatically determine the device node of a currently discovered TPM2
        device (of which there must be exactly one). The special value "<code class="literal">list</code>" may be used to
        enumerate all suitable TPM2 devices currently discovered.</p><p>In order to unlock a LUKS2 volume with an enrolled TPM2 security chip, specify the
        <code class="option">tpm2-device=</code> option in the respective <code class="filename">/etc/crypttab</code> line:</p><pre class="programlisting">myvolume /dev/sda1 - tpm2-device=auto</pre><p>See
        <a href="crypttab.html#"><span class="citerefentry"><span class="refentrytitle">crypttab</span>(5)</span></a> for a
        more comprehensive example of a <span class="command"><strong>systemd-cryptenroll</strong></span> invocation and its matching
        <code class="filename">/etc/crypttab</code> line.</p><p>Use <code class="option">--tpm2-pcrs=</code> (see below) to configure which TPM2 PCR indexes to bind the
        enrollment to.</p><p><a name="v248"></a>Added in version 248.</p></dd><dt id="--tpm2-device-key=PATH"><span class="term"><code class="option">--tpm2-device-key=</code><em class="replaceable"><code>PATH</code></em></span><a class="headerlink" title="Permalink to this term" href="#--tpm2-device-key=PATH">¶</a></dt><dd><p>Enroll a TPM2 security chip using its public key. Expects a path referring to the
        TPM2 public key in TPM2B_PUBLIC format. This cannot be used with <code class="option">--tpm2-device=</code>, as
        it performs the same operation, but without connecting to the TPM2 security chip; instead the
        enrollment is calculated using the provided TPM2 key. This is useful in situations where the TPM2
        security chip is not available at the time of enrollment.</p><p>The key, in most cases, should be the Storage Root Key (SRK) from a local TPM2 security
        chip. If a key from a different handle (not the SRK) is used, you must specify its handle index using
        <code class="option">--tpm2-seal-key-handle=</code>.</p><p>The
        <a href="systemd-tpm2-setup.service.html#"><span class="citerefentry"><span class="refentrytitle">systemd-tpm2-setup.service</span>(8)</span></a>
        service writes the SRK to <code class="filename">/run/systemd/tpm2-srk-public-key.tpm2b_public</code>
        automatically during boot, in the correct format.</p><p>Alternatively, you may use <span class="command"><strong>systemd-analyze srk</strong></span> to retrieve the SRK from the
        TPM2 security chip explicitly. See
        <a href="systemd-analyze.html#"><span class="citerefentry"><span class="refentrytitle">systemd-analyze</span>(1)</span></a>
        for details. Example:</p><pre class="programlisting">systemd-analyze srk &gt; srk.tpm2b_public</pre><p><a name="v255"></a>Added in version 255.</p></dd><dt id="--tpm2-seal-key-handle=HANDLE"><span class="term"><code class="option">--tpm2-seal-key-handle=</code><em class="replaceable"><code>HANDLE</code></em></span><a class="headerlink" title="Permalink to this term" href="#--tpm2-seal-key-handle=HANDLE">¶</a></dt><dd><p>Configures which parent key to use for sealing, using the TPM handle (index) of the
        key. This is used to "seal" (encrypt) a secret and must be used later to "unseal" (decrypt) the
        secret. Expects a hexadecimal 32bit integer, optionally prefixed with
        "<code class="literal">0x</code>". Allowable values are any handle index in the persistent
        ("<code class="literal">0x81000000</code>"-"<code class="literal">0x81ffffff</code>") or transient
        ("<code class="literal">0x80000000</code>"-"<code class="literal">0x80ffffff</code>") ranges. Since transient handles are
        lost after a TPM reset, and may be flushed during TPM context switching, they should not be used
        except for very specific use cases, e.g. testing.</p><p>The default is the Storage Root Key (SRK) handle index "<code class="literal">0x81000001</code>". A value
        of 0 will use the default. For the SRK handle, a new key will be created and stored in the TPM if one
        does not already exist; for any other handle, the key must already exist in the TPM at the specified
        handle index.</p><p>This should not be changed unless you know what you are doing.</p><p><a name="v255"></a>Added in version 255.</p></dd><dt id="--tpm2-pcrs=PCR"><span class="term"><code class="option">--tpm2-pcrs=</code> [PCR...]</span><a class="headerlink" title="Permalink to this term" href="#--tpm2-pcrs=PCR">¶</a></dt><dd><p>Configures the TPM2 PCRs (Platform Configuration Registers) to bind to when
        enrollment is requested via <code class="option">--tpm2-device=</code>. Takes a list of PCR entries, where each
        entry starts with a name or numeric index in the range 0…23, optionally followed by
        "<code class="literal">:</code>" and a hash algorithm name (specifying the PCR bank), optionally followed by
        "<code class="literal">=</code>" and a hash digest value. Multiple PCR entries are separated by
        "<code class="literal">+</code>". If not specified, the default is to use PCR 7 only. If an empty string is
        specified, binds the enrollment to no PCRs at all. See the table above for a list of available
        PCRs.</p><p>Example: <code class="option">--tpm2-pcrs=boot-loader-code+platform-config+boot-loader-config</code>
        specifies that PCR registers 4, 1, and 5 should be used.</p><p>Example: <code class="option">--tpm2-pcrs=7:sha256</code> specifies that PCR register 7 from the SHA256
        bank should be used.</p><p>Example: <code class="option">--tpm2-pcrs=4:sha1=3a3f780f11a4b49969fcaa80cd6e3957c33b2275</code>
        specifies that PCR register 4 from the SHA1 bank should be used, and a hash digest value of
        3a3f780f11a4b49969fcaa80cd6e3957c33b2275 will be used instead of reading the current PCR
        value.</p><p><a name="v248"></a>Added in version 248.</p></dd><dt id="--tpm2-with-pin=BOOL"><span class="term"><code class="option">--tpm2-with-pin=</code><em class="replaceable"><code>BOOL</code></em></span><a class="headerlink" title="Permalink to this term" href="#--tpm2-with-pin=BOOL">¶</a></dt><dd><p>When enrolling a TPM2 device, controls whether to require the user to enter a PIN
        when unlocking the volume in addition to PCR binding, based on TPM2 policy authentication. Defaults
        to "<code class="literal">no</code>". Despite being called PIN, any character can be used, not just numbers.
        </p><p>Note that incorrect PIN entry when unlocking increments the TPM dictionary attack lockout
        mechanism, and may lock out users for a prolonged time, depending on its configuration. The lockout
        mechanism is a global property of the TPM, <span class="command"><strong>systemd-cryptenroll</strong></span> does not control or
        configure the lockout mechanism. You may use tpm2-tss tools to inspect or configure the dictionary
        attack lockout, with <a href="https://www.mankier.com/1/tpm2_getcap"><span class="citerefentry"><span class="refentrytitle">tpm2_getcap</span>(1)</span></a>
        and <a href="https://www.mankier.com/1/tpm2_dictionarylockout"><span class="citerefentry"><span class="refentrytitle">tpm2_dictionarylockout</span>(1)</span></a>
        commands, respectively.</p><p><a name="v251"></a>Added in version 251.</p></dd><dt id="--tpm2-public-key=PATH"><span class="term"><code class="option">--tpm2-public-key=</code> [PATH], </span><span class="term"><code class="option">--tpm2-public-key-pcrs=</code> [PCR...], </span><span class="term"><code class="option">--tpm2-signature=</code> [PATH]</span><a class="headerlink" title="Permalink to this term" href="#--tpm2-public-key=PATH">¶</a></dt><dd><p>Configures a TPM2 signed PCR policy to bind encryption to. The
        <code class="option">--tpm2-public-key=</code> option accepts a path to a PEM encoded RSA public key, to bind
        the encryption to. If this is not specified explicitly, but a file
        <code class="filename">tpm2-pcr-public-key.pem</code> exists in one of the directories
        <code class="filename">/etc/systemd/</code>, <code class="filename">/run/systemd/</code>,
        <code class="filename">/usr/lib/systemd/</code> (searched in this order), it is automatically used. The
        <code class="option">--tpm2-public-key-pcrs=</code> option takes a list of TPM2 PCR indexes to bind to (same
        syntax as <code class="option">--tpm2-pcrs=</code> described above). If not specified defaults to 11 (i.e. this
        binds the policy to any unified kernel image for which a PCR signature can be provided).</p><p>Note the difference between <code class="option">--tpm2-pcrs=</code> and
        <code class="option">--tpm2-public-key-pcrs=</code>: the former binds decryption to the current, specific PCR
        values; the latter binds decryption to any set of PCR values for which a signature by the specified
        public key can be provided. The latter is hence more useful in scenarios where software updates shell
        be possible without losing access to all previously encrypted LUKS2 volumes. Like with
        <code class="option">--tpm2-pcrs=</code>, names defined in the table above can also be used to specify the
        registers, for instance
        <code class="option">--tpm2-public-key-pcrs=boot-loader-code+system-identity</code>.</p><p>The <code class="option">--tpm2-signature=</code> option takes a path to a TPM2 PCR signature file as
        generated by the
        <a href="systemd-measure.html#"><span class="citerefentry"><span class="refentrytitle">systemd-measure</span>(1)</span></a>
        tool. If this is not specified explicitly, a suitable signature file
        <code class="filename">tpm2-pcr-signature.json</code> is searched for in <code class="filename">/etc/systemd/</code>,
        <code class="filename">/run/systemd/</code>, <code class="filename">/usr/lib/systemd/</code> (in this order) and used.
        If a signature file is specified or found it is used to verify if the volume can be unlocked with it
        given the current PCR state, before the new slot is written to disk. This is intended as safety net
        to ensure that access to a volume is not lost if a public key is enrolled for which no valid
        signature for the current PCR state is available. If the supplied signature does not unlock the
        current PCR state and public key combination, no slot is enrolled and the operation will fail. If no
        signature file is specified or found no such safety verification is done.</p><p><a name="v252"></a>Added in version 252.</p></dd><dt id="--tpm2-pcrlock=PATH"><span class="term"><code class="option">--tpm2-pcrlock=</code> [PATH]</span><a class="headerlink" title="Permalink to this term" href="#--tpm2-pcrlock=PATH">¶</a></dt><dd><p>Configures a TPM2 pcrlock policy to bind encryption to. Expects a path to a pcrlock
        policy file as generated by the
        <a href="systemd-pcrlock.html#"><span class="citerefentry"><span class="refentrytitle">systemd-pcrlock</span>(1)</span></a>
        tool. If a TPM2 device is enrolled and this option is not used but a file
        <code class="filename">pcrlock.json</code> is found in <code class="filename">/run/systemd/</code> or
        <code class="filename">/var/lib/systemd/</code> it is automatically used. Assign an empty string to turn this
        behaviour off.</p><p><a name="v255"></a>Added in version 255.</p></dd><dt id="--wipe-slot=SLOT"><span class="term"><code class="option">--wipe-slot=</code> [SLOT...]</span><a class="headerlink" title="Permalink to this term" href="#--wipe-slot=SLOT">¶</a></dt><dd><p>Wipes one or more LUKS2 key slots. Takes a comma separated list of numeric slot
        indexes, or the special strings "<code class="literal">all</code>" (for wiping all key slots),
        "<code class="literal">empty</code>" (for wiping all key slots that are unlocked by an empty passphrase),
        "<code class="literal">password</code>" (for wiping all key slots that are unlocked by a traditional passphrase),
        "<code class="literal">recovery</code>" (for wiping all key slots that are unlocked by a recovery key),
        "<code class="literal">pkcs11</code>" (for wiping all key slots that are unlocked by a PKCS#11 token),
        "<code class="literal">fido2</code>" (for wiping all key slots that are unlocked by a FIDO2 token),
        "<code class="literal">tpm2</code>" (for wiping all key slots that are unlocked by a TPM2 chip), or any
        combination of these strings or numeric indexes, in which case all slots matching either are
        wiped. As safety precaution an operation that wipes all slots without exception (so that the volume
        cannot be unlocked at all anymore, unless the volume key is known) is refused.</p><p>This switch may be used alone, in which case only the requested wipe operation is executed. It
        may also be used in combination with any of the enrollment options listed above, in which case the
        enrollment is completed first, and only when successful the wipe operation executed — and the newly
        added slot is always excluded from the wiping. Combining enrollment and slot wiping may thus be used to
        update existing enrollments:</p><pre class="programlisting">systemd-cryptenroll /dev/sda1 --wipe-slot=tpm2 --tpm2-device=auto</pre><p>The above command will enroll the TPM2 chip, and then wipe all previously created TPM2
        enrollments on the LUKS2 volume, leaving only the newly created one. Combining wiping and enrollment
        may also be used to replace enrollments of different types, for example for changing from a PKCS#11
        enrollment to a FIDO2 one:</p><pre class="programlisting">systemd-cryptenroll /dev/sda1 --wipe-slot=pkcs11 --fido2-device=auto</pre><p>Or for replacing an enrolled empty password by TPM2:</p><pre class="programlisting">systemd-cryptenroll /dev/sda1 --wipe-slot=empty --tpm2-device=auto</pre><p><a name="v248"></a>Added in version 248.</p></dd><dt id="-h"><span class="term"><code class="option">-h</code>, </span><span class="term"><code class="option">--help</code></span><a class="headerlink" title="Permalink to this term" href="#-h">¶</a></dt><dd><p><a name="help-text"></a>Print a short help text and exit.
    </p></dd><dt id="--version"><span class="term"><code class="option">--version</code></span><a class="headerlink" title="Permalink to this term" href="#--version">¶</a></dt><dd><p><a name="version-text"></a>Print a short version string and exit.</p></dd></dl></div></div><div class="refsect1"><a name="id-1.9"></a><h2 id="Exit status">Exit status<a class="headerlink" title="Permalink to this headline" href="#Exit%20status">¶</a></h2><p>On success, 0 is returned, a non-zero failure code otherwise.</p></div><div class="refsect1"><a name="id-1.10"></a><h2 id="Examples">Examples<a class="headerlink" title="Permalink to this headline" href="#Examples">¶</a></h2><p><a href="crypttab.html#"><span class="citerefentry"><span class="refentrytitle">crypttab</span>(5)</span></a> and
    <a href="systemd-measure.html#"><span class="citerefentry"><span class="refentrytitle">systemd-measure</span>(1)</span></a>
    contain various examples employing <span class="command"><strong>systemd-cryptenroll</strong></span>.</p></div><div class="refsect1"><a name="id-1.11"></a><h2 id="See Also">See Also<a class="headerlink" title="Permalink to this headline" href="#See%20Also">¶</a></h2><p>
      <a href="systemd.html#"><span class="citerefentry"><span class="refentrytitle">systemd</span>(1)</span></a>,
      <a href="systemd-cryptsetup@.service.html#"><span class="citerefentry"><span class="refentrytitle">systemd-cryptsetup@.service</span>(8)</span></a>,
      <a href="crypttab.html#"><span class="citerefentry"><span class="refentrytitle">crypttab</span>(5)</span></a>,
      <a href="http://linux.die.net/man/8/cryptsetup"><span class="citerefentry"><span class="refentrytitle">cryptsetup</span>(8)</span></a>,
      <a href="systemd-measure.html#"><span class="citerefentry"><span class="refentrytitle">systemd-measure</span>(1)</span></a>
     </p></div></div></body></html>
